"""
ğŸ¬ Telegram Video Archive Bot - Ù†Ù‚Ø·Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
Ø¨ÙˆØª Ø£Ø±Ø´ÙŠÙ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ù…Ø¹ Keep Alive System
"""
import os
import time
import threading
import logging
import schedule
from dotenv import load_dotenv
import telebot

# ØªØ­Ù…ÙŠÙ„ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
load_dotenv()

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO,
    handlers=[logging.StreamHandler()]
)
logger = logging.getLogger(__name__)

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª
BOT_TOKEN = os.getenv('BOT_TOKEN')
DATABASE_URL = os.getenv('DATABASE_URL')
ADMIN_IDS = [int(x.strip()) for x in os.getenv('ADMIN_IDS', '').split(',') if x.strip()]

if not BOT_TOKEN:
    logger.error("âŒ BOT_TOKEN ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!")
    exit(1)

if not DATABASE_URL:
    logger.error("âŒ DATABASE_URL ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!")
    exit(1)

# Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
from app.database.connection import check_database, init_database
from app.services.user_service import UserService
from app.utils.keep_alive import run_keep_alive_system
from app.handlers.callbacks import register_all_callbacks
from app.handlers.text import register_text_handlers
from app.handlers.start import register_start_handlers
from app.handlers.admin import register_admin_handlers

# Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙˆØª
bot = telebot.TeleBot(BOT_TOKEN)


def setup_scheduler():
    """Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„ Ù„Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©"""
    # Ø¬Ø¯ÙˆÙ„Ø© ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ø¬Ù„ ÙŠÙˆÙ…ÙŠØ§Ù‹ ÙÙŠ 3 ØµØ¨Ø§Ø­Ø§Ù‹
    schedule.every().day.at("03:00").do(
        lambda: UserService.cleanup_old_history(15)  # 15 ÙŠÙˆÙ…
    )
    
    def run_scheduler():
        while True:
            schedule.run_pending()
            time.sleep(3600)  # ÙØ­Øµ ÙƒÙ„ Ø³Ø§Ø¹Ø©
    
    scheduler_thread = threading.Thread(target=run_scheduler, daemon=True)
    scheduler_thread.start()
    logger.info("âœ… Auto-cleanup scheduler started (15 days)")


def register_all_handlers():
    """ØªØ³Ø¬ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª"""
    # Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    register_start_handlers(bot)
    
    # Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
    register_admin_handlers(bot)
    
    # Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    register_all_callbacks(bot)
    
    # Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ù†ØµÙˆØµ
    register_text_handlers(bot)
    
    logger.info("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¨ÙˆØª")


def main():
    """Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    logger.info("ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø¨ÙˆØª Ø£Ø±Ø´ÙŠÙ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…...")
    
    # Ø¨Ø¯Ø¡ Ù†Ø¸Ø§Ù… Keep Alive
    run_keep_alive_system()
    
    # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„
    setup_scheduler()
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if not init_database():
        logger.error("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!")
        return
    
    logger.info("âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")
    
    # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª
    register_all_handlers()
    
    logger.info("ğŸ‰ Ø§Ù„Ø¨ÙˆØª Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„ 24/7 Ù…Ø¬Ø§Ù†Ø§Ù‹ Ù…Ø¹ Keep Alive!")
    logger.info(f"ğŸ”§ Ø§Ù„Ù…Ø´Ø±ÙÙˆÙ†: {ADMIN_IDS}")
    logger.info("ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…: /admin")
    
    # Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª
    bot.infinity_polling(timeout=60, long_polling_timeout=60)


if __name__ == "__main__":
    main()
